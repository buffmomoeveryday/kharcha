{% extends "base.html" %}
{% block content %}
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 bg-light min-vh-100 pb-5">
    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-4 border-bottom">
        <h1 class="h2">Debts & Credits</h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#contactModal">
                <i class="bi bi-person-plus"></i> Add Contact
            </button>
            <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#debtModal">
                <i class="bi bi-plus-lg"></i> Record Debt/Loan
            </button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm bg-success text-white">
                <div class="card-body p-3">
                    <small class="text-uppercase opacity-75 fw-bold">Total They Owe Me (Receivables)</small>
                    <h2 class="mb-0 fw-bold">NPR {{ total_receivable|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 shadow-sm bg-danger text-white">
                <div class="card-body p-3">
                    <small class="text-uppercase opacity-75 fw-bold">Total I Owe Them (Payables)</small>
                    <h2 class="mb-0 fw-bold">NPR {{ total_payable|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="btn-group shadow-sm">
            <a href="?status=active" class="btn btn-white border {% if current_status == 'active' %}active btn-dark{% endif %}">Active</a>
            <a href="?status=partial" class="btn btn-white border {% if current_status == 'partial' %}active btn-dark{% endif %}">Partially Paid</a>
            <a href="?status=settled" class="btn btn-white border {% if current_status == 'settled' %}active btn-dark{% endif %}">Settled</a>
            <a href="?status=all" class="btn btn-white border {% if current_status == 'all' %}active btn-dark{% endif %}">All</a>
        </div>
        <span class="text-muted small">Showing: <strong>{{ debts|length }}</strong> records</span>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="table-light">
                        <th class="ps-3">Contact</th>
                        <th>Type</th>
                        <th>Initial Amount</th>
                        <th>Remaining</th>
                        <th>Progress</th>
                        <th class="text-end pe-3">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in debts %}
                    <tr>
                        <td class="ps-3">
                            <div class="fw-bold">{{ d.contact.name }}</div>
                            <small class="text-muted">{{ d.contact.phone|default:"No phone" }}</small>
                        </td>
                        <td>
                            {% if d.debt_type == 'payable' %}
                                <span class="badge bg-danger-subtle text-danger">I OWE</span>
                            {% else %}
                                <span class="badge bg-success-subtle text-success">OWES ME</span>
                            {% endif %}
                        </td>
                        <td>NPR {{ d.initial_amount|floatformat:2 }}</td>
                        <td class="fw-bold {% if d.debt_type == 'payable' %}text-danger{% else %}text-success{% endif %}">
                            NPR {{ d.remaining_amount|floatformat:2 }}
                        </td>
                        <td>
                            {% if d.is_settled %}
                                <span class="badge bg-secondary">Settled</span>
                            {% else %}
                                <div class="progress" style="height: 6px; width: 100px;">
                                    {% widthratio d.remaining_amount d.initial_amount 100 as pc_rem %}
                                    <div class="progress-bar bg-primary" style="width: {{ 100|add:"-"|add:pc_rem }}%"></div>
                                </div>
                                <small class="extra-small text-muted">{{ 100|add:"-"|add:pc_rem }}% Paid</small>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3">
                            {% if not d.is_settled %}
                            <button class="btn btn-sm btn-dark" onclick="openPaymentModal('{{ d.id }}', '{{ d.remaining_amount }}', '{{ d.contact.name }}')">
                                Pay/Collect
                            </button>
                            {% else %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-center py-5 text-muted">No records found for this filter.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>
<div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" class="modal-content border-0 shadow">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_contact">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">New Contact</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold small">Full Name</label>
                    <input type="text" name="name" class="form-control" placeholder="e.g. John Doe" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">Phone Number (Optional)</label>
                    <input type="text" name="phone" class="form-control" placeholder="98XXXXXXXX">
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary px-4">Save Contact</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="debtModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" class="modal-content border-0 shadow">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_debt">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Lend or Borrow Money</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold small">Select Contact</label>
                    <select name="contact" class="form-select" required>
                        <option value="" disabled selected>Choose a person...</option>
                        {% for c in contacts %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">Transaction Type</label>
                    <select name="debt_type" class="form-select">
                        <option value="payable">I am Borrowing (My Cash goes UP)</option>
                        <option value="receivable">I am Lending (My Cash goes DOWN)</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold small">Amount (NPR)</label>
                        <input type="number" step="0.01" name="amount" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold small">From/To Account</label>
                        <select name="account" class="form-select" required>
                            {% for a in accounts %}<option value="{{ a.id }}">{{ a.name }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="submit" class="btn btn-dark w-100">Save Transaction</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="post" class="modal-content border-0 shadow">
            {% csrf_token %}
            <input type="hidden" name="action" value="make_payment">
            <input type="hidden" name="debt_id" id="pay_debt_id">
            <div class="modal-header">
                <h5 class="modal-title">Settle with <span id="pay_contact_name" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <small class="text-muted d-block text-uppercase fw-bold">Outstanding Balance</small>
                    <h2 class="fw-bold text-primary">NPR <span id="pay_max_amount"></span></h2>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">How much are you paying/receiving?</label>
                    <input type="number" step="0.01" name="amount" id="pay_input_amount" class="form-control form-control-lg" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">Using Account</label>
                    <select name="account" class="form-select" required>
                        {% for a in accounts %}<option value="{{ a.id }}">{{ a.name }} (Bal: {{ a.balance }})</option>{% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success w-100 py-2">Confirm Payment</button>
            </div>
        </form>
    </div>
</div>

<script>
/**
 * Injects data into the Payment Modal before showing it
 */
function openPaymentModal(id, amount, name) {
    document.getElementById('pay_debt_id').value = id;
    document.getElementById('pay_max_amount').innerText = amount;
    
    const amountInput = document.getElementById('pay_input_amount');
    amountInput.max = amount;
    amountInput.value = amount;
    
    document.getElementById('pay_contact_name').innerText = name;
    
    var myModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    myModal.show();
}
</script>
{% endblock content %}